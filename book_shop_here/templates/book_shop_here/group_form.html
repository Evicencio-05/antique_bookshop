{% extends "book_shop_here/base.html" %}
{% load i18n %}
{% load crispy_forms_tags %}

{% block content %}
    <div class="bg-white p-6 rounded shadow">
        <h1 class="text-2xl font-bold text-blue-600 mb-4">{{ title|default:"Add Role" }}</h1>
        <form method="post" class="space-y-4">
            {% csrf_token %}
            <div class="space-y-4 max-w-md">
                {{ form.non_field_errors }}
                {{ form.name|as_crispy_field }}
                {{ form.description|as_crispy_field }}
            </div>

            <div class="mt-6">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-xl font-semibold">{% trans "Permissions" %}</h2>
                    <div class="space-x-2">
                        <button type="button" id="perm-select-all" class="px-3 py-1 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm">{% trans "Select all" %}</button>
                        <button type="button" id="perm-select-domain" class="px-3 py-1 rounded bg-green-600 hover:bg-green-700 text-white text-sm">{% trans "Select domain" %}</button>
                        <button type="button" id="perm-select-auth" class="px-3 py-1 rounded bg-purple-600 hover:bg-purple-700 text-white text-sm">{% trans "Select auth" %}</button>
                        <button type="button" id="perm-clear-all" class="px-3 py-1 rounded bg-red-600 hover:bg-red-700 text-white text-sm">{% trans "Clear all" %}</button>
                    </div>
                </div>
                <div class="relative overflow-x-auto max-h-96">
                    <table class="w-full border border-gray-300 border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border border-gray-200 px-3 py-2 text-left sticky top-0 left-0 bg-gray-50 z-20">{% trans "Permission" %}</th>
                                {% for code,label in permission_models_all %}
                                    <th class="border border-gray-200 px-3 py-2 text-center sticky top-0 bg-gray-50 z-10">
                                        <div class="flex items-center justify-center space-x-2">
                                            <span>{{ label|title }}</span>
                                            <label class="inline-flex items-center justify-center rounded border border-gray-300 cursor-pointer">
                                                <input type="checkbox" class="h-4 w-4 col-toggle" data-col="{{ forloop.counter0 }}" data-col-type="{% if forloop.counter0 < permission_domain_count %}domain{% else %}auth{% endif %}" />
                                            </label>
                                        </div>
                                    </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in permission_rows %}
                                {% with row_index=forloop.counter0 %}
                                <tr>
                                    <td class="border border-gray-200 px-3 py-2 sticky left-0 bg-white z-10">
                                        <div class="flex items-center justify-between">
                                            <span>{{ row.action_label }}</span>
                                            <input type="checkbox" class="h-4 w-4 row-toggle" data-row="{{ row_index }}" />
                                        </div>
                                    </td>
                                    {% for cell in row.cells %}
                                        <td class="border border-gray-200 px-3 py-2 text-center">
                                            {% if cell.perm_id %}
                                                <input type="checkbox" name="permissions" value="{{ cell.perm_id }}" class="h-4 w-4 perm-checkbox" data-row="{{ row_index }}" data-col="{{ forloop.counter0 }}" {% if form.permissions.value and cell.perm_id|stringformat:'s' in form.permissions.value %}checked{% endif %} />
                                            {% else %}
                                                <span class="text-gray-400">—</span>
                                            {% endif %}
                                        </td>
                                    {% endfor %}
                                </tr>
                                {% endwith %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                {% if extra_permissions %}
                <div class="mt-6">
                    <h3 class="text-lg font-semibold mb-2">{% trans "Additional permissions" %}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        {% for p in extra_permissions %}
                        <label class="inline-flex items-center space-x-2 border p-2 rounded">
                            <input type="checkbox" name="permissions" value="{{ p.id }}" class="h-4 w-4" {% if form.permissions.value and p.id|stringformat:'s' in form.permissions.value %}checked{% endif %}>
                            <span class="text-sm">{{ p.codename }} — {{ p.name }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <script>
                (function(){
                    var table = document.currentScript.parentElement.querySelector('table');
                    if(!table) return;
                    var permBoxes = table.querySelectorAll('input.perm-checkbox');
                    function setCol(col, checked){
                        table.querySelectorAll('input.perm-checkbox[data-col="'+col+'"]').forEach(function(cb){ cb.checked = checked; });
                    }
                    function setRow(row, checked){
                        table.querySelectorAll('input.perm-checkbox[data-row="'+row+'"]').forEach(function(cb){ cb.checked = checked; });
                    }
                    table.querySelectorAll('.col-toggle').forEach(function(cb){
                        cb.addEventListener('change', function(){ setCol(this.getAttribute('data-col'), this.checked); });
                    });
                    table.querySelectorAll('.row-toggle').forEach(function(cb){
                        cb.addEventListener('change', function(){ setRow(this.getAttribute('data-row'), this.checked); });
                    });
                    var btnAll = document.getElementById('perm-select-all');
                    var btnNone = document.getElementById('perm-clear-all');
                    var btnDom = document.getElementById('perm-select-domain');
                    var btnAuth = document.getElementById('perm-select-auth');
                    if(btnAll){ btnAll.addEventListener('click', function(){ permBoxes.forEach(function(cb){ cb.checked = true; }); }); }
                    if(btnNone){ btnNone.addEventListener('click', function(){ permBoxes.forEach(function(cb){ cb.checked = false; }); }); }
                    function setColsByType(type, checked){
                        table.querySelectorAll('.col-toggle[data-col-type="'+type+'"]').forEach(function(hcb){
                        setCol(hcb.getAttribute('data-col'), checked);
                        });
                    }
                    if(btnDom){ btnDom.addEventListener('click', function(){ setColsByType('domain', true); }); }
                    if(btnAuth){ btnAuth.addEventListener('click', function(){ setColsByType('auth', true); }); }
                })();
                </script>
            </div>

            {% url 'book_shop_here:group-list' as cancel_link %}
            <div class="mt-8 flex items-center space-x-4">
                <button type="submit" class="inline-flex items-center bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded focus:outline-none focus:ring-2 focus:ring-green-500">{% trans "Save" %}</button>
                <a href="{{ cancel_link }}" class="inline-flex items-center bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded focus:outline-none focus:ring-2 focus:ring-red-500">{% trans "Cancel" %}</a>
            </div>
        </form>
    </div>
{% endblock %}
